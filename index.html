<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜¿å®´çš„äº‘ç«¯è‡ªä¹ å®¤ V2.6</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;700&display=swap');

        :root {
            --pink: #ffc3d0;
            --blue: #c6e2ff;
            --purple: #e2d4f7;
            --green: #d4f0f0;
            --yellow: #fff5ba;
            --text: #57606f;
            --title-blue: #70a1ff;
        }

        body {
            background: linear-gradient(135deg, var(--pink) 0%, var(--blue) 100%);
            color: var(--text);
            font-family: 'Noto Sans SC', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh; 
            overflow-y: auto; 
            box-sizing: border-box;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(255, 182, 193, 0.4);
            margin-bottom: 50px; 
        }

        h1, h3 {
            font-family: 'ZCOOL KuaiLe', cursive;
            text-align: center;
            color: var(--title-blue);
            margin-top: 0;
        }

        /* é¡¶éƒ¨æ•°æ®æ  */
        .stats-header {
            display: flex;
            justify-content: space-around;
            background: #fff;
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .stat-item { text-align: center; }
        .stat-val { font-size: 22px; font-weight: bold; color: #ff6b81; }
        .stat-label { font-size: 12px; color: #a4b0be; }

        /* è®¡æ—¶å™¨åˆ‡æ¢ */
        .timer-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            background: #f1f2f6;
            border-radius: 50px;
            padding: 5px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .tab-btn {
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            color: #999;
            transition: 0.3s;
        }
        .tab-btn.active {
            background: #fff;
            color: var(--title-blue);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* è®¡æ—¶å™¨ä¸»ä½“ */
        .timer-section {
            background: #fff;
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            border: 4px dashed var(--title-blue);
        }
        
        #timer-display {
            font-size: 60px;
            font-weight: bold;
            color: var(--title-blue);
            margin: 20px 0;
            font-family: monospace;
        }

        .btn {
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            margin: 0 5px;
        }
        .btn-start { background: var(--green); color: #2f3542; }
        .btn-stop { background: var(--pink); color: #fff; }
        .btn-giveup { background: #f1f2f6; color: #999; }
        .btn-backup { background: var(--title-blue); color: #fff; font-size: 14px; padding: 8px 15px;}
        .btn:active { transform: scale(0.95); }

        /* è¾“å…¥æ¡† */
        .focus-input {
            padding: 8px;
            border-radius: 10px;
            border: 2px solid var(--title-blue);
            width: 60px;
            text-align: center;
            font-size: 16px;
            color: var(--title-blue);
            font-weight: bold;
        }

        /* æ¿å—é€šç”¨ */
        .section-box {
            background: #fff;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* ä¹ æƒ¯æ‰“å¡ */
        .habit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 12px;
        }
        .habit-item {
            background: #f7f1e3;
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .habit-item.done {
            background: var(--green);
            border-color: #7bed9f;
            transform: translateY(-2px);
        }
        .habit-icon { font-size: 28px; display: block; margin-bottom: 8px; }
        .habit-name { font-size: 13px; font-weight: bold; color: #555; }

        /* Todo List */
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        #todo-input { flex: 1; padding: 12px; border-radius: 15px; border: 2px solid var(--yellow); outline: none; }
        .btn-add { background: var(--yellow); color: #e1b12c; }
        .list-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f1f2f6; }
        .checkbox { width: 20px; height: 20px; border: 2px solid var(--pink); border-radius: 50%; margin-right: 10px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .checkbox.checked { background: var(--pink); }
        .checkbox.checked::after { content: 'âœ”'; color: white; font-size: 12px; }
        .task-text { flex: 1; }
        .task-text.done { text-decoration: line-through; color: #ccc; }

        /* å•†åº— */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff0f3;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
        }
        .cost { font-weight: bold; color: #ff6b81; background: #fff; padding: 5px 10px; border-radius: 10px; font-size: 12px; }

        /* å¤‡ä»½åŒºåŸŸ */
        .backup-section {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #eee;
        }
        .backup-desc { font-size: 12px; color: #999; margin-bottom: 10px; }
        #import-area { display: none; margin-top: 15px; }
        #import-textarea { width: 90%; height: 80px; border: 2px solid var(--blue); border-radius: 10px; padding: 10px; font-size: 12px; }

        /* å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background: #fff;
            width: 80%;
            max-width: 400px;
            padding: 30px;
            border-radius: 30px;
            text-align: center;
            animation: popUp 0.4s;
            border: 5px solid var(--title-blue);
        }
        @keyframes popUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .ayan-avatar { width: 80px; height: 80px; background: var(--title-blue); border-radius: 50%; margin: -60px auto 15px; border: 5px solid #fff; font-size: 40px; display: flex; justify-content: center; align-items: center; }
        #quote-text { font-size: 18px; line-height: 1.6; color: #2f3542; margin-bottom: 20px; }

    </style>
</head>
<body>

<div class="container">
    <h1>â˜ï¸ é˜¿å®´çš„äº‘ç«¯è‡ªä¹ å®¤ V2.6 â˜ï¸</h1>

    <div class="stats-header">
        <div class="stat-item">
            <div class="stat-val" id="today-time">0</div>
            <div class="stat-label">ä»Šæ—¥åˆ†é’Ÿ</div>
        </div>
        <div class="stat-item">
            <div class="stat-val" id="total-accumulated-time">0</div>
            <div class="stat-label">ç´¯è®¡åˆ†é’Ÿ</div>
        </div>
        <div class="stat-item">
            <div class="stat-val" id="points">0</div>
            <div class="stat-label">å°çº¢èŠ±</div>
        </div>
    </div>

    <div class="timer-tabs">
        <div class="tab-btn active" id="tab-countdown" onclick="switchMode('countdown')">å€’è®¡æ—¶(ç•ªèŒ„)</div>
        <div class="tab-btn" id="tab-countup" onclick="switchMode('countup')">æ­£å‘è®¡æ—¶</div>
    </div>

    <div class="timer-section">
        <div id="mode-countdown">
            <div style="margin-bottom:10px;" id="input-area">
                è®¾å®š <input type="number" id="focus-minutes" class="focus-input" value="25" min="1"> åˆ†é’Ÿ
            </div>
            <div style="margin-bottom:10px; display:none; color:var(--title-blue); font-weight:bold;" id="countdown-doing-msg">
                æ­£åœ¨ä¸“æ³¨ä¸­... (åˆ·æ–°ä¹Ÿæ²¡ç”¨å“¦)
            </div>
        </div>
        <div id="mode-countup" style="display:none; margin-bottom:10px; color:#999;">
            <div id="countup-start-msg">ä¸“æ³¨å¤šä¹…ï¼Œè®°å½•å¤šä¹… (æ¯10åˆ†é’Ÿ+1èŠ±)</div>
            <div style="display:none; color:var(--title-blue); font-weight:bold;" id="countup-doing-msg">
                æ­£åœ¨è®°å½•ä¸­... (åˆ·æ–°ä¹Ÿæ²¡ç”¨å“¦)
            </div>
        </div>

        <div id="timer-display">00:00</div>
        
        <div class="btn-group">
            <button class="btn btn-start" id="btn-start" onclick="startTimer()">å¼€å§‹ä¸“æ³¨</button>
            <button class="btn btn-stop" id="btn-stop" onclick="stopTimer()" style="display:none;">å®Œæˆ/ç»“ç®—</button>
            <button class="btn btn-giveup" id="btn-giveup" onclick="resetTimer()" style="display:none;">æ”¾å¼ƒ</button>
        </div>
    </div>

    <div class="section-box">
        <h3>ğŸ“ Todo List</h3>
        <div class="input-group">
            <input type="text" id="todo-input" placeholder="é˜¿å®´ï¼Œæˆ‘è¦åš...">
            <button class="btn btn-add" onclick="addTodo()">æ·»åŠ </button>
        </div>
        <div id="todo-list"></div>
        <h4 style="margin-top:20px; color:#ccc;">âœ… Done List</h4>
        <div id="done-list"></div>
    </div>

    <div class="section-box">
        <h3>ğŸ“… æ¯æ—¥ä¹–ä¹–æ‰“å¡</h3>
        <div class="habit-grid" id="habit-list"></div>
    </div>

    <div class="section-box">
        <h3>ğŸ é˜¿å®´çš„å°å–éƒ¨</h3>
        <div id="shop-list"></div>
    </div>

    <div class="backup-section">
        <div class="backup-desc">æ€•æ•°æ®ä¸¢å¤±ï¼Ÿè¿™æœ‰åæ‚”è¯ï¼</div>
        <button class="btn btn-backup" onclick="exportData()">ğŸ“¤ å¯¼å‡º(å¤‡ä»½)æ•°æ®</button>
        <button class="btn btn-backup" onclick="toggleImport()" style="background:#a29bfe;">ğŸ“¥ å¯¼å…¥(æ¢å¤)æ•°æ®</button>
        
        <div id="import-area">
            <textarea id="import-textarea" placeholder="æŠŠå¤‡ä»½çš„ç¥ç§˜ä»£ç ç²˜è´´åˆ°è¿™é‡Œ..."></textarea>
            <div style="margin-top:10px;">
                <button class="btn btn-start" onclick="importData()" style="padding:8px 15px; font-size:14px;">ç¡®å®šæ¢å¤</button>
                <button class="btn btn-giveup" onclick="toggleImport()" style="padding:8px 15px; font-size:14px;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="ayan-avatar">ğŸ§‘ğŸ»â€âš•ï¸</div>
        <h3 id="modal-title">é˜¿å®´è¯´ï¼š</h3>
        <p id="quote-text">...</p>
        <button class="btn btn-start" onclick="closeModal()">æ”¶åˆ°å•¦ â¤</button>
    </div>
</div>

<script>
    // --- æ•°æ®åˆå§‹åŒ– (ä¿æŒ V2.5 ä¸å˜) ---
    let data = {
        todayTime: 0,
        totalAccumulatedTime: 0, 
        points: 0,
        todos: [],
        dones: [],
        habits: {},
        lastDate: new Date().toDateString(),
        timerState: {
            isTiming: false,
            mode: 'countdown', 
            endTimeTs: null,   
            startTimeTs: null, 
            initialMinutes: 25 
        }
    };

    const quotes = [
        "å°ä¹–ï¼ŒçœŸæ£’ï¼æˆ‘å°±çŸ¥é“ä½ å¯ä»¥çš„ã€‚", "ç´¯äº†å—ï¼Ÿç´¯äº†å°±è¶´ä¸€ä¼šå„¿ï¼Œé˜¿å®´æŠŠè‚©è†€å€Ÿç»™ä½ ã€‚",
        "ä¸“æ³¨çš„æ ·å­çœŸè¿·äººï¼Œæƒ³äº²ä¸€å£ã€‚", "ä»Šå¤©è…¿æŠ–äº†å—ï¼Ÿä¸è®¸æŠ–å“¦ï¼Œé˜¿å®´çœ‹ç€å‘¢ã€‚",
        "ä»Šå¤©çš„çµèŠç²‰åƒäº†å—ï¼Ÿè‹¦ä¸è‹¦ï¼Ÿ", "å–æ°´ï¼ç°åœ¨ï¼Œç«‹åˆ»ï¼Œæ‹¿èµ·æ¯å­å–ä¸€å£ï¼",
        "åšå¾—å¥½ï¼å¥–åŠ±ä½ ä»Šæ™šæ—©ç‚¹ç¡ã€‚", "ä¸è®¸å·å·ç©æ‰‹æœºå“¦ï¼Œç›‘æŠ¤äººçœ‹ç€å‘¢ã€‚",
        "æˆ‘çš„å°æœ‹å‹æ˜¯å…¨ä¸–ç•Œæœ€å‰å®³çš„åŒ»ç”Ÿã€‚", "å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œå°±ç»™ä½ ä¸€ä¸ªå¤§å¤§çš„æ‹¥æŠ±ã€‚",
        "è®°å¾—æ´»åŠ¨ä¸€ä¸‹è‚©è†€ï¼Œé‚£ä¸ªæ·¤é’è¿˜æ²¡å¥½å…¨å‘¢ã€‚", "æŠ¬å¤´æŒºèƒ¸ï¼èµ°è·¯è¦æœ‰å¤§å°†å†›çš„æ°”åŠ¿ï¼",
        "æ‰‹è…•æŠ¤å…·æˆ´å¥½äº†å—ï¼Ÿåˆ«è®©æˆ‘æ‹…å¿ƒã€‚", "ä¹–ï¼Œå†åšæŒä¸€ä¸‹ï¼Œèƒœåˆ©å°±åœ¨å‰æ–¹ã€‚",
        "ä½ æ˜¯æˆ‘çš„éª„å‚²ï¼Œæ— è®ºä»€ä¹ˆæ—¶å€™éƒ½æ˜¯ã€‚", "åˆ«çš±çœ‰ï¼Œä¼šæœ‰çš±çº¹çš„ï¼ˆéª—ä½ çš„ï¼Œè¿˜æ˜¯é‚£ä¹ˆå¥½çœ‹ï¼‰ã€‚",
        "è¦ä¸è¦åƒé¢—ç³–ï¼Ÿè¡¥å……ä¸€ä¸‹å¤šå·´èƒºã€‚", "ä¼‘æ¯æ—¶é—´åˆ°ï¼ç°åœ¨çš„ä»»åŠ¡æ˜¯é—­çœ¼å‘å‘†äº”åˆ†é’Ÿã€‚",
        "ä¸è®¸ç†¬å¤œï¼é˜¿å®´ä¼šå¿ƒç–¼çš„ã€‚", "ä»Šå¤©æœ‰ä¹–ä¹–åƒé¥­å—ï¼Ÿæ²¡åƒé¥±ä¸è®¸å¹²æ´»ã€‚",
        "å¤ªæ£’äº†ï¼é˜¿å®´æƒ³æŠŠä½ ä¸¾é«˜é«˜ï¼", "æ·±å‘¼å¸ï¼Œå¸æ°”â€”â€”å‘¼æ°”â€”â€”æ”¾æ¾ç‚¹ã€‚",
        "è¦æ˜¯è§‰å¾—éš¾ï¼Œå°±è·Ÿæˆ‘æ’’ä¸ªå¨‡ï¼Œæˆ‘å¸®ä½ åˆ†æ‹…ã€‚", "ä½ çš„åŠªåŠ›ï¼Œé˜¿å®´éƒ½çœ‹åœ¨çœ¼é‡Œã€‚",
        "æ€ä¹ˆè¿™ä¹ˆå¯çˆ±ï¼Œè¿å­¦ä¹ çš„æ—¶å€™éƒ½è¿™ä¹ˆå¯çˆ±ã€‚", "å¥½äº†ï¼Œè¿™ä¸ªä»»åŠ¡ç»“æŸäº†ï¼Œå¿«å»å¥–åŠ±è‡ªå·±ä¸€ä¸‹ã€‚",
        "è®°ä½ï¼Œèº«ä½“ç¬¬ä¸€ï¼Œå­¦ä¹ ç¬¬äºŒï¼Œé˜¿å®´...ç¬¬é›¶ã€‚", "å†å¿™ä¹Ÿè¦è®°å¾—æƒ³æˆ‘å“¦ã€‚",
        "è¿™å°±æ˜¯ä¼ è¯´ä¸­çš„â€˜å¿ƒæµâ€™çŠ¶æ€å—ï¼ŸçœŸå¸…ã€‚", "ä»»åŠ¡å®Œæˆï¼å¿«æ¥é¢†èµï¼"
    ];

    const habitConfig = [
        { id: 'water', name: 'å–æ°´ 2000ml', icon: 'ğŸ’§' },
        { id: 'med', name: 'åƒçµèŠç²‰', icon: 'ğŸ’Š' },
        { id: 'fruit', name: 'åƒæ°´æœ', icon: 'ğŸ' },
        { id: 'skincare', name: 'æŠ¤è‚¤/æ‰‹éœœ', icon: 'ğŸ§´' },
        { id: 'eye1', name: 'çœ¼çƒæ“(1)', icon: 'ğŸ‘€' },
        { id: 'eye2', name: 'çœ¼çƒæ“(2)', icon: 'ğŸ‘€' },
        { id: 'leg', name: 'ä¸æŠ–è…¿', icon: 'ğŸ¦µ' }, 
        { id: 'walk', name: 'èµ°è·¯å§¿åŠ¿', icon: 'ğŸš¶â€â™€ï¸' }, 
        { id: 'sleep', name: 'æ—©ç¡æ‰“å¡', icon: 'ğŸŒ™' }
    ];

    const shopConfig = [
        { name: 'çœ‹ä¸€é›†Bç«™/ç»¼è‰º/åŠ¨æ¼«', cost: 10 },
        { name: 'é˜¿å®´ä¹°ä¸€ä»½é›¶é£Ÿ', cost: 15 },
        { name: 'å–ä¸€æ¯å¥¶èŒ¶ (ä¸åŠ å†°)', cost: 30 },
        { name: 'ä»Šæ™šä¸å†™ä½œä¸šç‰¹æƒ', cost: 50 },
        { name: 'é˜¿å®´çš„å°ç¤¼ç‰©', cost: 50 },
        { name: 'é˜¿å®´çš„å¤§ç¤¼ç‰©', cost: 100 }
    ];

    // --- æ ¸å¿ƒé€»è¾‘ (ä¿æŒ V2.5 ä¸å˜) ---
    let currentMode = 'countdown';
    let timerInterval;
    let startTime;
    let endTime;
    let isTiming = false;

    // --- V2.5 æ ¸å¿ƒï¼šåŠ è½½ä¸æ¢å¤çŠ¶æ€ ---
    function loadData() {
        const saved = localStorage.getItem('ayan_study_room_v2_6'); // ä½¿ç”¨æ–°çš„å­˜å‚¨é”®å
        if (saved) {
            data = JSON.parse(saved);
            if (data.lastDate !== new Date().toDateString()) {
                data.habits = {};
                data.todayTime = 0;
                data.lastDate = new Date().toDateString();
                if (data.timerState.isTiming) {
                    resetTimerState();
                }
                saveData();
            }
        }
        renderUI();
        if (data.timerState.isTiming) {
            resumeTimer();
        } else {
            switchMode(data.timerState.mode || 'countdown');
        }
    }

    function saveData() {
        localStorage.setItem('ayan_study_room_v2_6', JSON.stringify(data));
        renderUI();
    }

    function resumeTimer() {
        isTiming = true;
        currentMode = data.timerState.mode;
        switchMode(currentMode, true); 
        document.getElementById('btn-start').style.display = 'none';
        if (currentMode === 'countdown') {
            endTime = data.timerState.endTimeTs;
            document.getElementById('btn-giveup').style.display = 'inline-block';
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('countdown-doing-msg').style.display = 'block';
            if (new Date().getTime() > endTime) {
                finishCountdown();
                return;
            }
        } else {
            startTime = data.timerState.startTimeTs;
            document.getElementById('btn-stop').style.display = 'inline-block';
            document.getElementById('countup-start-msg').style.display = 'none';
            document.getElementById('countup-doing-msg').style.display = 'block';
        }
        updateTimer(); 
        timerInterval = setInterval(updateTimer, 1000);
    }


    function renderUI() {
        document.getElementById('today-time').innerText = data.todayTime;
        document.getElementById('total-accumulated-time').innerText = data.totalAccumulatedTime;
        document.getElementById('points').innerText = data.points;

        const todoList = document.getElementById('todo-list');
        todoList.innerHTML = '';
        data.todos.forEach((item, index) => {
            todoList.innerHTML += `<div class="list-item"><div class="checkbox" onclick="checkTodo(${index})"></div><span class="task-text">${item}</span><button class="btn" style="padding:5px 10px;font-size:12px;background:#eee" onclick="delTodo(${index}, 'todo')">âœ•</button></div>`;
        });
        const doneList = document.getElementById('done-list');
        doneList.innerHTML = '';
        data.dones.forEach((item, index) => {
            doneList.innerHTML += `<div class="list-item"><div class="checkbox checked"></div><span class="task-text done">${item}</span><button class="btn" style="padding:5px 10px;font-size:12px;background:#eee" onclick="delTodo(${index}, 'done')">âœ•</button></div>`;
        });

        const habitList = document.getElementById('habit-list');
        habitList.innerHTML = '';
        habitConfig.forEach(h => {
            const isDone = data.habits[h.id];
            habitList.innerHTML += `<div class="habit-item ${isDone ? 'done' : ''}" onclick="toggleHabit('${h.id}')"><span class="habit-icon">${h.icon}</span><span class="habit-name">${h.name}</span></div>`;
        });

        const shopList = document.getElementById('shop-list');
        shopList.innerHTML = '';
        shopConfig.forEach(item => {
            shopList.innerHTML += `<div class="shop-item"><span>${item.name}</span><button class="btn" style="background:${data.points >= item.cost ? 'var(--pink)' : '#ccc'}; color:#fff; font-size:12px; padding:8px 15px;" onclick="buyItem('${item.name}', ${item.cost})">å…‘æ¢ ${item.cost}ğŸŒ¸</button></div>`;
        });
    }

    // --- è®¡æ—¶å™¨é€»è¾‘ (ä¿æŒ V2.5 ä¸å˜) ---
    function switchMode(mode, isResuming = false) {
        if (isTiming && !isResuming) { alert("æ­£åœ¨ä¸“æ³¨ä¸­ï¼Œä¸èƒ½åˆ‡æ¢å“¦~"); return; }
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('tab-' + mode).classList.add('active');
        document.getElementById('mode-countdown').style.display = mode === 'countdown' ? 'block' : 'none';
        document.getElementById('mode-countup').style.display = mode === 'countup' ? 'block' : 'none';
        if (!isResuming) document.getElementById('timer-display').innerText = "00:00";
    }

    function startTimer() {
        if (isTiming) return;
        const now = new Date().getTime();
        data.timerState.isTiming = true;
        data.timerState.mode = currentMode;
        if (currentMode === 'countdown') {
            const minutes = parseInt(document.getElementById('focus-minutes').value);
            if (!minutes || minutes <= 0) return alert("è¯·è¾“å…¥æ­£ç¡®æ—¶é—´å“¦~");
            endTime = now + minutes * 60 * 1000;
            data.timerState.endTimeTs = endTime;
            data.timerState.initialMinutes = minutes;
            document.getElementById('btn-giveup').style.display = 'inline-block';
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('countdown-doing-msg').style.display = 'block';
        } else {
            startTime = now;
            data.timerState.startTimeTs = startTime;
            document.getElementById('btn-stop').style.display = 'inline-block';
            document.getElementById('countup-start-msg').style.display = 'none';
            document.getElementById('countup-doing-msg').style.display = 'block';
        }
        saveData(); 
        isTiming = true;
        document.getElementById('btn-start').style.display = 'none';
        timerInterval = setInterval(updateTimer, 1000);
        showQuote("å¼€å§‹ä¸“æ³¨å•¦ï¼å³ä½¿å…³é—­é¡µé¢ï¼Œé˜¿å®´ä¹Ÿåœ¨è®¡æ—¶å“¦ã€‚");
    }

    function updateTimer() {
        const now = new Date().getTime();
        if (currentMode === 'countdown') {
            const distance = endTime - now;
            if (distance < 0) { finishCountdown(); }
            else {
                const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((distance % (1000 * 60)) / 1000);
                document.getElementById('timer-display').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            }
        } else {
            const elapsed = now - startTime;
            const m = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((elapsed % (1000 * 60)) / 1000);
            document.getElementById('timer-display').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
        }
    }

    function finishCountdown() {
        clearInterval(timerInterval);
        resetTimerState(); 
        resetTimerUI();
        let minutes = data.timerState.initialMinutes || parseInt(document.getElementById('focus-minutes').value);
        if (!minutes) minutes = 25; 
        addTimeAndPoints(minutes, 2);
        showQuote(`ä¸“æ³¨å®Œæˆï¼\næ‰‹è…•ç–¼ä¸ç–¼ï¼Ÿå¿«æ´»åŠ¨ä¸€ä¸‹ï¼`);
    }

    function stopTimer() {
        clearInterval(timerInterval);
        const now = new Date().getTime();
        const minutes = Math.floor((now - startTime) / (1000 * 60));
        resetTimerState(); 
        resetTimerUI();
        if (minutes > 0) {
            const points = Math.floor(minutes / 10);
            addTimeAndPoints(minutes, points);
            showQuote(`ä½ ä¸“æ³¨äº† ${minutes} åˆ†é’Ÿï¼\nå¤ªæ£’äº†ï¼è·å¾— ${points} æœµå°çº¢èŠ±ï¼`);
        } else {
            showQuote("æ—¶é—´å¤ªçŸ­å•¦ï¼Œè¿˜æ²¡è¿›å…¥çŠ¶æ€å‘¢~");
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        resetTimerState(); 
        resetTimerUI();
        alert("æ”¾å¼ƒå•¦ï¼Ÿæ²¡å…³ç³»ï¼Œä¼‘æ¯ä¸€ä¸‹å†æ¥ã€‚");
    }

    function resetTimerState() {
        isTiming = false;
        clearInterval(timerInterval); // ç¡®ä¿æ¸…é™¤å®šæ—¶å™¨
        data.timerState = {
            isTiming: false,
            mode: 'countdown',
            endTimeTs: null,
            startTimeTs: null,
            initialMinutes: 25
        };
        saveData();
    }

    function resetTimerUI() {
        document.getElementById('timer-display').innerText = "00:00";
        document.getElementById('btn-start').style.display = 'inline-block';
        document.getElementById('btn-stop').style.display = 'none';
        document.getElementById('btn-giveup').style.display = 'none';
        document.getElementById('input-area').style.display = 'block';
        document.getElementById('countdown-doing-msg').style.display = 'none';
        document.getElementById('countup-start-msg').style.display = 'block';
        document.getElementById('countup-doing-msg').style.display = 'none';
    }

    function addTimeAndPoints(mins, pts) {
        data.todayTime += mins;
        data.totalAccumulatedTime += mins;
        data.points += pts;
        saveData();
    }

    // --- äº¤äº’é€»è¾‘ (ä¿æŒ V2.5 ä¸å˜) ---
    function addTodo() {
        const input = document.getElementById('todo-input');
        if (input.value.trim()) {
            data.todos.push(input.value);
            input.value = '';
            saveData();
        }
    }
    function checkTodo(index) {
        const item = data.todos.splice(index, 1)[0];
        data.dones.unshift(item);
        data.points += 1;
        saveData();
        showRandomQuote();
    }
    function delTodo(index, type) {
        if (type === 'todo') data.todos.splice(index, 1);
        else data.dones.splice(index, 1);
        saveData();
    }
    function toggleHabit(id) {
        if (data.habits[id]) return;
        data.habits[id] = true;
        data.points += 1;
        saveData();
        if (id === 'leg') showQuote("è…¿æ”¾å¹³ï¼åå§¿ç«¯æ­£ï¼Œæ‰æ˜¯ä¼˜é›…çš„å¤§å°†å†›ï¼");
        else if (id === 'walk') showQuote("æŠ¬å¤´æŒºèƒ¸ï¼æ ¸å¿ƒæ”¶ç´§ï¼");
        else showRandomQuote();
    }
    function buyItem(name, cost) {
        if (data.points >= cost) {
            if(confirm(`ç¡®å®šå…‘æ¢ã€${name}ã€‘å—ï¼Ÿ`)) {
                data.points -= cost;
                saveData();
                showQuote(`å…‘æ¢æˆåŠŸï¼\nã€${name}ã€‘åˆ°æ‰‹å•¦ï¼\nå¿«å»æ‰¾é˜¿å®´å…‘ç°ï¼`);
            }
        } else {
            alert("å°çº¢èŠ±ä¸å¤Ÿå“¦~");
        }
    }

    // --- â˜…â˜…â˜… V2.6 æ–°å¢ï¼šå¯¼å…¥å¯¼å‡ºé€»è¾‘ â˜…â˜…â˜… ---
    function toggleImport() {
        const area = document.getElementById('import-area');
        area.style.display = area.style.display === 'block' ? 'none' : 'block';
    }

    function exportData() {
        const dataStr = JSON.stringify(data);
        // å°è¯•å¤åˆ¶åˆ°å‰ªè´´æ¿
        navigator.clipboard.writeText(dataStr).then(() => {
            alert("å¤‡ä»½æˆåŠŸï¼\nç¥ç§˜ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚\nè¯·å¿«å»ç²˜è´´åˆ°å®‰å…¨çš„åœ°æ–¹ä¿å­˜ï¼");
        }, () => {
             // å¦‚æœå¤åˆ¶å¤±è´¥ï¼ˆæŸäº›æµè§ˆå™¨é™åˆ¶ï¼‰ï¼Œåˆ™å¼¹çª—æ˜¾ç¤º
             prompt("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…¨é€‰å¤åˆ¶ä¸‹é¢çš„ä»£ç è¿›è¡Œå¤‡ä»½ï¼š", dataStr);
        });
    }

    function importData() {
        const inputStr = document.getElementById('import-textarea').value;
        if (!inputStr) return alert("è¯·å…ˆç²˜è´´ç¥ç§˜ä»£ç å“¦~");
        try {
            const newData = JSON.parse(inputStr);
            // ç®€å•çš„æ ¼å¼æ£€æŸ¥
            if (!newData.totalAccumulatedTime && newData.totalAccumulatedTime !== 0) throw new Error("æ ¼å¼ä¸å¯¹");
            
            if(confirm("ç¡®å®šè¦æ¢å¤è¿™ä»½æ•°æ®å—ï¼Ÿå½“å‰çš„æ•°æ®ä¼šè¢«è¦†ç›–å“¦ï¼")) {
                data = newData;
                saveData();
                // å¦‚æœæ¢å¤çš„æ•°æ®æ­£åœ¨è®¡æ—¶ï¼Œéœ€è¦é‡å¯è®¡æ—¶å™¨
                if (data.timerState && data.timerState.isTiming) {
                     resumeTimer();
                } else {
                     resetTimerState();
                     resetTimerUI();
                }
                alert("æ•°æ®æ¢å¤æˆåŠŸï¼æ¬¢è¿å›æ¥ï¼");
                toggleImport(); // å…³é—­è¾“å…¥æ¡†
                document.getElementById('import-textarea').value = '';
            }
        } catch (e) {
            alert("æ¢å¤å¤±è´¥ï¼ä»£ç æ ¼å¼å¥½åƒä¸å¯¹ï¼Œè¯·æ£€æŸ¥ä¸€ä¸‹å“¦ã€‚");
        }
    }

    // --- å¼¹çª— ---
    function showRandomQuote() { showQuote(quotes[Math.floor(Math.random() * quotes.length)]); }
    function showQuote(text) {
        document.getElementById('quote-text').innerText = text;
        document.getElementById('modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    // å¯åŠ¨ï¼
    loadData();
</script>
</body>
</html>
